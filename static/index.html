<!DOCTYPE html>
<html lang="en-GB">

<head>
    <meta charset="utf-8">
    <title>GoBkm</title>
    <meta name="description" content="A minimalist folder-based bookmark manager">
    <meta name="author" content="Thomas Bellembois">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <!-- from https://realfavicongenerator.net/ -->
    <link rel="icon" type="image/png" href="/img/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/img/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/img/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/img/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest/manifest.json">
    <link rel="mask-icon" href="/img/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-TileImage" content="/img/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <link rel="stylesheet" type="text/css" href="/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/css/bootstrap-theme.min.css">
    <link rel="stylesheet" type="text/css" href="/css/ui.fancytree.min.css">
    <link rel="stylesheet" type="text/css" href="/css/jquery.contextMenu.min.css">
    <link rel="stylesheet" type="text/css" href="/css/jquery-ui.min.css">
    <link rel="stylesheet" type="text/css" href="/css/main.css">

    <!-- Some variables passed by the handler -->
    <script>
        var GoBkmProxyURL = "{{.GoBkmProxyURL}}"
        var GoBkmProxyHost = "{{.GoBkmProxyHost}}"
    </script>

    <!-- Include jQuery -->
    
    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery-ui.min.js"></script>
    <script src="/js/jquery.contextMenu.min.js"></script>

    <!-- Include Bootstrap -->
    <script type="text/javascript" src="/js/bootstrap.min.js"></script>
    <!-- Include Clipboard-->
    <script type="text/javascript" src="/js/clipboard.min.js"></script>

    <script src="/js/jquery.fancytree.min.js"></script>
    <script src="/js/jquery.fancytree.table.js"></script>
    <script src="/js/jquery.fancytree.gridnav.js"></script>
    <script src="/js/jquery.fancytree.edit.js"></script>
    <script src="/js/jquery.fancytree.dnd.js"></script>
    <script src="/js/jquery.fancytree.glyph.js"></script>
    <script src="/js/jquery.fancytree.contextMenu.js"></script>
  </head>

<body>

<div ondrop="dzDrop(event)" ondragover="dzAllowDrop(event)" id="drop-zone" title="drop new bookmarks here">
    <span class="badge">
        <i class="fa fa-cloud-download" aria-hidden="true"></i>
    </span>
</div>

<div class="container-fluid" id="container">

    <!--
    Copy to clipboard messages
    -->
    <div id="clipboard-message-ok" class="alert alert-success" role="alert">
      copied to clipboard
    </div>
    <div id="clipboard-message-nok" class="alert alert-danger" role="alert">
      an error occured trying to copy to clipboard
    </div>

    <!--
    Starred bookmarks
    -->
    <div id="starred-list">
        <div class="panel panel-default">
            <span class="glyphicon glyphicon-star" aria-hidden="true"></span>
            <div class="panel-body">
                <ul id="starred">
                {{with .Bkms}}
                {{range .}}
                    <li id="bookmark-starred-{{.Id}}">
                       <div class="bookmark">
                            <img src="{{.Favicon}}" alt="" class="favicon">
                            <span class="bookmark-starred-link" 
                                  title="{{.URL}}" 
                                  onclick="window.open('{{.URL}}', '_blank');">{{.Title}}
                            </span>
                            <a href="#" onclick="unStar('{{.Id}}');" class="glyphicon glyphicon-remove" aria-hidden="true" title="Remove star."></a>
                        </div>
                    </li>
                {{end}}
                {{end}}
            </ul>
          </div>
        </div>
    </div>

    <!-- Search form -->
    <div id="search-box">
        <div class="input-group">
            <span class="input-group-addon" id="basic-addon1">
                <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
            </span>
            <input type="text" id="search-form-input" class="form-control" placeholder="Search a bookmark title..." aria-describedby="basic-addon1">
        </div>
        <div id="search-result">
        </div>
    </div>

    <!-- Main tree -->
    <div id="scrollParent" style="height: 100%; overflow: auto;">
        <table id="tree">
            <colgroup>
                <col></col>
                <col></col>
                <col></col>
            </colgroup>
            <thead>
                <tr><th></th><th></th><th></th><th></th></tr>
            </thead>
            <tbody>
                <tr><td></td><td class="hidden-xs hidden-sm" /><td></td><td></td></tr>
            </tbody>
        </table>
    </div>

    <!-- Footer -->
    <div id="footer">

        <!-- Import form -->
        <div id="action-box">
            <div id="import-input-box" style="display:none">
                <form id="import-file-form" action="/import/" method="post" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="input-group">
                                <input type="file" name="importFile" accept=".html" id="import-file" class="form-control">
                                <span class="input-group-btn">
                                <button onclick="document.getElementById('import-file-form').submit();" class="btn btn-default" type="button"><span class="glyphicon glyphicon-download" aria-hidden="true" ></span></button>
                                </span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Copyright -->
        <div id="copyright">
            <!--
            <img id="logo" src="/img/favicon.svg" alt="logo" title="GoBkm - Copyright (C) 2006-2016 Thomas Bellembois. Licensed under the GNU GPL, Version 3.0."/>
    -->
        </div>

        <!-- Bookmarklets -->
        <div id="bookmarklet" style="display: none;">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">bookmarklets</h3>
                </div>
                <div class="panel-body">
                    <div id="bookmarklet-app">
                        <a title="GoBkm application bookmarklet: drop me in bookmarks bar." href="javascript:window.open('{{.GoBkmProxyURL}}?target=_blank','sbPopWin','directories=no,width=200,height=600,left=0,top=0,scrollbars=yes,location=no,menubar=no, status=no, toolbar=no');void(0)">GoBkm application</a>
                    </div>
                    <div id="bookmarklet-add">
                        <a title="GoBkm bookmark current page bookmarklet; drop me in your bookmarks bar." href="javascript:window.open('{{.GoBkmProxyURL}}/bookmarkThis/?target=_self&url=' + encodeURI(location.href) + '&title=' + document.title,'sbPopWin','directories=no,width=200,height=600,left=0,top=0,scrollbars=yes,location=no,menubar=no, status=no, toolbar=no');void(0)">GoBkm bookmark current page</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Import and export buttons -->
        <div id="import-export">
            <div class="btn-group" role="group" aria-label="...">
                <button type="button" title="export bookmarks" class="btn btn-default" id="export-box"><span class="glyphicon glyphicon-upload" aria-hidden="true"></span></button>
                <button type="button" title="import bookmarks" class="btn btn-default" id="import-box"><span class="glyphicon glyphicon-download" aria-hidden="true"></span></button>
                <button type="button" title="bookmarklets" class="btn btn-default" id="bookmaklet-box" onclick="toggleElement('bookmarklet')"><span class="glyphicon glyphicon-globe" aria-hidden="true"></span></button>
            </div>
        </div>
    </div>

</div>

<!-- Initialize the tree when page is loaded -->
<script type="text/javascript">
    $(function() {
        // Instanciate clipboard for file links.
        var clipboard = new Clipboard('button', {
            target: function(trigger) {
                return trigger.nextElementSibling;
            }
        });

        clipboard.on('success', function(e) {
            //console.log(e.text);
            $("#clipboard-message-ok").fadeTo(500, 500).slideUp(500, function(){
                $("#clipboard-message-ok ").slideUp(500);
            });   
            e.clearSelection();
        });

        clipboard.on('error', function(e) {
        });

        $("#clipboard-message-ok").hide();
        $("#clipboard-message-nok").hide();

        // Create the tree inside the <div id="tree"> element.
        $("#tree").fancytree({
            extensions: ["edit", "dnd", "glyph", "contextMenu", "table", "gridnav"],
            scrollParent: $("#scrollParent"),
            autoScroll: true,
              contextMenu: {
                  menu: function(node){
                      if (node.folder){                 
                        return {
                            "edit": { "name": "edit", icon: "fa-edit" },
                            "delete": { "name": "delete", icon: "fa-trash-o" },
                            "new": { "name": "new subfolder", icon: "fa-folder-o" },
                            sep1: "-----",
                            "fold1": {
                                "name": "new bookmark from URL", 
                                icon: "fa-globe",
                                "items": {
                                     newBkm: {
                                        type: 'text', 
                                        value: "", 
                                        events: {
                                            keyup: function(e) {
                                                if (e.keyCode == 13) {
                                                     $.ajax({
                                                        url: "/addBookmark/",
                                                        data: {
                                                            destinationFolderId: node.key,
                                                            bookmarkUrl: $("input[name=context-menu-input-newBkm]").val()
                                                        }
                                                    }).done(function(result) {
                                                        node.load(forceReload=true).then(
                                                            function() {
                                                                if (! node.isExpanded()) {
                                                                    node.setExpanded(true);
                                                                }
                                                            }
                                                        );
                                                    }).always(function() {
                                                        $('.context-menu-root').first().trigger("contextmenu:hide");
                                                    });
                                                } 
                                            }
                                        }
                                    }
                                }
                            },
                        };
                      } else {
                        return {
                            "star": { "name": "star", icon: "fa-star" },
                            "edit": { "name": "edit", icon: "fa-edit" },
                            "delete": { "name": "delete", icon: "fa-trash" },
                        };
                       }
                    },
                actions: function(node, action, options) {
                    //console.log("Selected action '" + action + "' on node " + node);
                    switch (action) {
                        case "star":
                            star(node.key);
                            break;
                        case "edit":
                            node.editStart();
                            break;
                        case "new":
                            $.ajax({
                                url: "/addFolder/",
                                data: {
                                    folderName: "new folder",
                                    parentId: node.key
                                }
                            }).done(function(result) {
                                node.load(forceReload=true).then(
                                    function() {
                                        node.setExpanded(true).then(
                                            function() {
                                                tree = $("#tree").fancytree("getTree");
                                                newNode = tree.getNodeByKey(result.key.toString());
                                                newNode.moveTo(node, 'firstChild');
                                                newNode.setActive();
                                                newNode.editStart();
                                            });
                                    });
                            });                           
                            break;
                        case "delete":
                            //console.log("delete");
                            if (node.isFolder()) {
                                ajaxUrl = "/deleteFolder/"
                            } else {
                                ajaxUrl = "/deleteBookmark/"
                            }
                            // Save data.input.val() or return false to keep the editor open
                            $.ajax({
                                url: ajaxUrl,
                                data: {
                                    itemId: node.key
                                }
                            }).done(function(result) {
                                node.remove();
                            });
                            break;
                    }
                }
              },
            filter: {
                counter: false,
                mode: "hide"
            },
            glyph: {
                preset: "bootstrap3",
                map: {}
            },
            dnd: {
                dragStart: function(node, data) {
                    return true;
                },
                dragEnter: function(node, data) {
                    if (data.node.isFolder()) {
                        return ["over"];
                    }
                    return false;
                },
                dragStop: function(node, data) {
                    node.setExpanded(true);
                },
                dragDrop: function(node, data) {
                    fromNode = data.otherNode; // dragged item
                    toNode = node;

                    if (fromNode.isFolder()) {
                        ajaxUrl = "/moveFolder/"
                    } else {
                        ajaxUrl = "/moveBookmark/"
                    }
                    $.ajax({
                        url: ajaxUrl,
                        data: {
                            sourceItemId: fromNode.key,
                            destinationItemId: toNode.key
                        }

                    }).done(function(result) {
                        // the method explained here:
                        // https://github.com/mar10/fancytree/wiki/ExtDnd#howto-drop-on-a-lazy-node
                        // does not work because "always" is not call for new directories
                        // TODO: to be improved
                        fromNode.moveTo(toNode, data.hitMode);
                        toNode.load(forceReload=true).always(function(){
                            toNode.setExpanded(true);
                        });
                    });
                }
            },
            edit: {
                triggerStart: ["f2", "shift+click"],
                save: function(event, data) {
                    var node = data.node;

                    if (node.isFolder()) {
                        ajaxUrl = "/renameFolder/"
                    } else {
                        ajaxUrl = "/renameBookmark/"
                    }
                    $.ajax({
                        url: ajaxUrl,
                        data: {
                            itemId: node.key,
                            itemName: data.input.val()
                        }
                    }).done(function(result) {
                        node.setTitle(result.Title); // in case server modified it
                    }).fail(function(result) {
                        node.setTitle(data.orgTitle);
                    }).always(function() {
                        $(data.node.span).removeClass("pending");
                    });
                    return true;
                },
                close: function(event, data) {
                    // Editor was removed. If we started an async request, mark the node as pending
                    if (data.save) {
                        $(data.node.span).addClass("pending");
                    }
                },
            },
            source: [{
                title: "/",
                key: "1",
                active: true,
                folder: true,
                lazy: true
            }],
            lazyLoad: function(event, data) {
                var node = data.node;
                data.result = {
                    url: "/getBranchNodes/",
                    data: {
                        key: node.key
                    }
                }
            },
            renderColumns: function(event, data) {
                var node = data.node;
                var url = node.data.url;
                var nbButton = $(node).find('button').length;

                if (! node.isFolder() && url.startsWith("file") && nbButton == 0) {
                    var murl = url.split('/').reverse()[0];
                    if (murl == "") {
                        murl = url.split('/').reverse()[1];
                    }
                    stitle = $(node.span).find('span.fancytree-title').first();
                    stitle.html("");
                    stitle.attr("id", "file");
                    stitle.before('<button class="copy-button" title="copy to clipboard"><i class="fa fa-clipboard" aria-hidden="true"></i></button>');
                    stitle.before('<div class="copy-text">' + url + '</div>');
                }
            },
            icon: function(event, data) {
                return data.node.isFolder() ? true : data.node.icon;
            },
            tooltip: function(event, data) {
                return data.node.isFolder() ? "" : data.node.data.url;
            },
        }).on("mouseenter", ".fancytree-title", function(event){
			var node = $.ui.fancytree.getNode(event);
            setTimeout(
              function() 
              {
                node.setActive();
              }, 200);
        }).on("mouseup", ".fancytree-title", function(event){
                //console.log("mouseup:" + event.which);
                clearSearchResults();
                $("input#search-form-input").val("");

                var node = $.ui.fancytree.getNode(event);

                // Handle only left click
                if (event.which == 1 && !node.title.startsWith("file")) {
                   $("div#search-result").html("");
                   $("input#search-form-input").val("");
                   $("button#confirm-delete").fadeOut();
                   
                   if( node.isFolder() ) {
                   } else {
                       if (node.isActive() && node.data.url) {
                           window.open(node.data.url, "_blank");
                       }
                       $("button#bookmark").prop("disabled", false);    
                       $("button#delete").prop("disabled", false);    
                   }
                }
        });
    });
</script>

<script type="text/javascript">
    $(function() {
        if (window.location.protocol == "https:") {
            wsproto = "wss";
        } else {
            wsproto = "ws";
        }
        var ws= new WebSocket(wsproto + "://{{.GoBkmProxyHost}}/socket/");

        ws.onmessage = function(evt) {
            //console.log( "Received Message: " + evt.data);
            newBookmark = createBookmarkLi(evt.ID, evt.Title, evt.URL, "")

            tree = $("#tree").fancytree("getTree");
            activeNode = tree.getNodeByKey("1");
            activeNodeKey = activeNode.key;

            activeNode.load(forceReload=true).then(
                function() {
                    if (! activeNode.isExpanded()) {
                        activeNode.setExpanded(true);
                    }
                }
            );
        };
    });
</script>

<script>
    function dzAllowDrop(ev) {
        ev.preventDefault();
    }

    function dzDrop(ev) {
        ev.preventDefault();
        
        var data
        dttypes = ev.dataTransfer.types;
        if ($.inArray("text/uri-list", dttypes) != -1) {
            data = ev.dataTransfer.getData("text/uri-list");
        } else if($.inArray("text/x-moz-url", dttypes) != -1) {
            data = ev.dataTransfer.getData("text/x-moz-url");
        } else {
            alert("not supported by your browser");
            return;
        }
        console.log(data);
        //console.log(ev.dataTransfer.types);
        // ["text/plain", "text/uri-list"]
        // ["text/plain", "text/x-moz-url"
        tree = $("#tree").fancytree("getTree");
    
        //activeNode = tree.getNodeByKey("1");
        activeNode = tree.getActiveNode();
        if (! activeNode) {
            activeNode = tree.getNodeByKey("1");
            activeNode = $("#tree").fancytree("getRootNode");
        } 
        if (!activeNode.isFolder()) {
            activeNode = activeNode.getParent();
        }
        activeNodeKey = activeNode.key;

        $.ajax({
            url: "/addBookmark/",
            data: {
                destinationFolderId: activeNodeKey,
                bookmarkUrl: data
            }
        }).done(function(result) {
            activeNode.load(forceReload=true).then(
                function() {
                    if (! activeNode.isExpanded()) {
                        activeNode.setExpanded(true);
                    }
                }
            );
        }).always(function() {
        });

    }
</script>

<script>
    function star(id) {
         $.ajax({
            url: "/starBookmark/",
            data: {
                bookmarkId: id,
                star: true
            }
        }).done(function(result) {
            newID = result.Id
            newFavicon = result.Favicon
            newURL = result.URL
            newTitle = result.Title
            $("ul#starred").append(createStarredBookmarkLi(newID, newTitle, newURL, newFavicon));
        }).always(function() {
        });
    }
    function unStar(id) {
        $.ajax({
            url: "/starBookmark/",
            data: {
                bookmarkId: id,
                star: false
            }
        }).done(function(result) {
            $("li#bookmark-starred-" + id).remove();
        }).always(function() {
        });
    }
</script>

<script>
    function clearSearchResults() {
        $("div#search-result").html("");
    }
    function toggleElement(id) {
        var el = document.getElementById(id);
        el.style.display = el.style.display == "none" ? "block" : "none";
    }
</script>

<script>
    function createStarredBookmarkLi(bID, bTitle, bURL, bFavicon) {
        newBookmark = " \
            <li id='bookmark-starred-ID'> \
                <div class='bookmark'> \
                    <img src=\"SRC\" alt='' class='favicon'> \
                    <span class='bookmark-starred-link'  title=\"URL\" onclick='window.open(\"URL\", \"_blank\");'>TITLE</span> \
                    <a href='#' onclick=\"unStar('ID');\" class='glyphicon glyphicon-remove' aria-hidden='true' title='Remove bookmark.'></a> \
                </div> \
            </li> \
        "
        newBookmark = newBookmark.replace("ID", bID);
        newBookmark = newBookmark.replace("ID", bID);
        newBookmark = newBookmark.replace("SRC", bFavicon);
        newBookmark = newBookmark.replace("URL", bURL);
        newBookmark = newBookmark.replace("URL", bURL);
        newBookmark = newBookmark.replace("TITLE", bTitle);
        return newBookmark;
    }

    function createBookmarkLi(bID, bTitle, bURL, bFavicon) {
        newBookmark = " \
            <li id='bookmark-starred-ID'> \
                <div class='bookmark'> \
                    <img src=\"SRC\" alt='' class='favicon'> \
                    <span class='bookmark-starred-link' title=\"URL\" onclick='window.open(\"URL\", \"_blank\");'>TITLE</span> \
                </div> \
            </li> \
        "
        newBookmark = newBookmark.replace("ID", bID);
        newBookmark = newBookmark.replace("SRC", bFavicon);
        newBookmark = newBookmark.replace("URL", bURL);
        newBookmark = newBookmark.replace("URL", bURL);
        newBookmark = newBookmark.replace("TITLE", bTitle);
        return newBookmark;
    }
</script>

<script>
// https://schier.co/blog/2014/12/08/wait-for-user-to-stop-typing-using-javascript.html
// Get the input box
var searchInput = document.getElementById('search-form-input');

// Init a timeout variable to be used below
var timeout = null;

// Listen for keystroke events
searchInput.onkeyup = function (e) {

    if (searchInput.value.length < 2) {
        return;
    }

    // Clear the timeout if it has already been set.
    // This will prevent the previous task from executing
    // if it has been less than <MILLISECONDS>
    clearTimeout(timeout);

    // Make a new timeout set to go off in 800ms
    timeout = setTimeout(function () {
        // console.log('Input Value:', searchInput.value);
        $.ajax({
            url: "/searchBookmarks/",
            data: {
                search: searchInput.value
            }
        }).done(function(result) {
            if (result == null) {
                return;
            }
            //console.log(result);
            clearSearchResults();
            // Close button
            $("div#search-result").append('<div id="close-search-results-button" title="close list" onclick="clearSearchResults();">&#x2716;</div>');
            $.each(result, function(key,value) {
                //console.log(value);
                $("div#search-result").append(createBookmarkLi(value.Id, value.Title, value.URL, value.Favicon));
            });
        });
    }, 500);
};
</script>

<script>
    $("button#export-box").click(function() {
         window.open('/export/?target=_blank');
    });
    $("button#import-box").click(function() {
        $("div#import-input-box").toggle(); 
    });
</script>
</body>

</html>
